{"version":3,"sources":["main.js.flow"],"names":["Hugo","require","CSON","path","fs","Project","Icons","checkEnv","clearCache","process","env","terminalApp","config","get","set","workflowMeta","version","clearCacheSync","checkIcons","projects","themePath","alfredMeta","themeFile","lastTheme","cache","statSync","join","__dirname","theme","rebuild","cacheFile","on","checkDependencies","resolve","err","action","query","length","feedback","homedir","HOME","projectsFile","file","parse","parseAll","onlyMissing","sort","a","b","nameA","title","toLowerCase","nameB","store","Array","isArray","usedIcons","console","error","addItem","subtitle","arg","variables","task","valid","mods","alt","addItems","filterItems","trim","itemCount"],"mappings":"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","file":"main.js","sourcesContent":["// @flow\n\nconst Hugo = require('alfred-hugo');\nconst CSON = require('cson-parser');\nconst path = require('path');\nconst fs = require('fs');\n\nconst Project = require('./project');\nconst Icons = require('./icons');\n\n/**\n * Check for environment changes (workflow version, terminal app, nodejs path)\n * @return {void}\n */\nconst checkEnv = (): void => {\n    let clearCache = false;\n\n    // Terminal app\n    if (process.env.terminalApp && Hugo.config.get('terminalApp') !== process.env.terminalApp) {\n        clearCache = true;\n        Hugo.config.set('terminalApp', process.env.terminalApp);\n    }\n\n    // Workflow version\n    if (Hugo.workflowMeta.version && Hugo.config.get('wfVersion') !== Hugo.workflowMeta.version) {\n        clearCache = true;\n        Hugo.config.set('wfVersion', Hugo.workflowMeta.version);\n    }\n\n    if (clearCache === true) {\n        Hugo.clearCacheSync();\n    }\n};\n\n/**\n * Check if we need to rebuild icons\n * @param {Array.Object} projects\n * @return {Promise}\n */\nconst checkIcons = async (projects: Array<Object>): Promise<void> => {\n    const themePath: string = Hugo.alfredMeta.themeFile;\n    const lastTheme: ?string = Hugo.cache.get('lastTheme');\n\n    try {\n        fs.statSync(path.join(__dirname, 'icons'));\n    } catch (e) {\n        Hugo.cache.set('lastTheme', Hugo.alfredMeta.theme);\n        Icons.rebuild(projects);\n        return;\n    }\n\n    if (!lastTheme || lastTheme !== Hugo.alfredMeta.theme) {\n        Hugo.cache.set('lastTheme', Hugo.alfredMeta.theme);\n        Icons.rebuild(projects);\n        return;\n    }\n\n    if (themePath) {\n        const themeFile = Hugo.cacheFile(themePath, 'theme');\n\n        themeFile.on('change', () => {\n            Icons.rebuild(projects);\n        });\n\n        themeFile.get();\n    }\n};\n\n/**\n * Check workflow dependencies\n * @return {boolean}\n */\nconst checkDependencies = (): boolean => {\n    try {\n        require.resolve('svgexport');\n    } catch (err) {\n        return false;\n    }\n\n    return true;\n};\n\n/**\n * Projects action\n */\nHugo.action('projects', query => {\n    if (!query || query.length === 0) {\n        Hugo.feedback();\n        return;\n    }\n\n    // Home dir\n    const homedir = process.env.HOME || '';\n\n    // Projects file\n    const projectsFile = Hugo.cacheFile(path.resolve(homedir, '.atom', 'projects.cson'), 'projects');\n\n    // Check environment for changes\n    checkEnv();\n\n    // Parse projects\n    projectsFile.on('change', (cache, file) => {\n        // Read projects file\n        let projects = CSON.parse(file) || [];\n\n        // Parse projects\n        projects = Project.parseAll(projects);\n\n        // Rebuild icons when needed\n        Icons.rebuild(projects, {onlyMissing: true});\n\n        // Sort projects\n        projects.sort((a, b) => {\n            let nameA = a.title.toLowerCase();\n            let nameB = b.title.toLowerCase();\n\n            if (nameA < nameB) {\n                return -1;\n            }\n\n            if (nameA > nameB) {\n                return 1;\n            }\n\n            return 0;\n        });\n\n        cache.store(projects);\n    });\n\n    // Add projects to Hugo\n    let projects = projectsFile.get();\n\n    if (projects && Array.isArray(projects)) {\n        // Check dependencies for icon building\n        if (!checkDependencies() && Icons.usedIcons(projects).length > 0) {\n            console.error(`Missing dependencies to render project icons. Please run: cd ${__dirname} && npm install`);\n\n            Hugo.addItem({\n                title: 'Missing dependencies',\n                subtitle: 'Missing dependencies to render project icons. Please press enter to install.',\n                arg: {\n                    arg: __dirname,\n                    variables: {\n                        task: 'wfDependencies'\n                    }\n                },\n                valid: true,\n                mods: {\n                    alt: {\n                        valid: true,\n                        subtitle: 'View documentation on this issue.',\n                        arg: 'https://github.com/Cloudstek/alfred-hugo/blob/master/README.md'\n                    }\n                }\n            });\n        }\n\n        // Add projects to Hugo\n        Hugo.addItems(projects);\n\n        // Check icons\n        checkIcons(projects);\n    }\n\n    // Filter items by query\n    Hugo.filterItems(query.trim());\n\n    // Check if any projects found\n    if (Hugo.itemCount < 1) {\n        Hugo.addItem({\n            title: 'No projects found.'\n        });\n    }\n\n    // Output\n    Hugo.feedback();\n});\n"]}