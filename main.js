"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault");var _regenerator=_interopRequireDefault(require("@babel/runtime/regenerator"));var _asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));var Hugo=require('alfred-hugo');var CSON=require('cson-parser');var path=require('path');var fs=require('fs');var Project=require('./project');var Icons=require('./icons');var checkEnvironmentChanges=function checkEnvironmentChanges(){var clearCache=false;if(process.env.terminalApp&&Hugo.config.get('terminalApp')!==process.env.terminalApp){clearCache=true;Hugo.config.set('terminalApp',process.env.terminalApp);}if(Hugo.workflowMeta.version&&Hugo.config.get('wfVersion')!==Hugo.workflowMeta.version){clearCache=true;Hugo.config.set('wfVersion',Hugo.workflowMeta.version);}if(clearCache===true){Hugo.clearCacheSync();}};var checkIcons=function(){var _ref=(0,_asyncToGenerator2.default)(_regenerator.default.mark(function _callee(projects){var themePath,lastTheme,themeFile;return _regenerator.default.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:themePath=Hugo.alfredMeta.themeFile;lastTheme=Hugo.config.get('lastTheme');_context.prev=2;fs.statSync(path.join(__dirname,'icons'));_context.next=11;break;case 6:_context.prev=6;_context.t0=_context["catch"](2);Hugo.config.set('lastTheme',Hugo.alfredMeta.theme);Icons.rebuild(projects);return _context.abrupt("return");case 11:if(!(!lastTheme||lastTheme!==Hugo.alfredMeta.theme)){_context.next=15;break;}Hugo.config.set('lastTheme',Hugo.alfredMeta.theme);Icons.rebuild(projects);return _context.abrupt("return");case 15:if(themePath){themeFile=Hugo.cacheFile(themePath,'theme');themeFile.on('change',function(){Icons.rebuild(projects);});themeFile.get();}Icons.rebuild(projects,{onlyMissing:true});case 17:case"end":return _context.stop();}}},_callee,this,[[2,6]]);}));return function checkIcons(_x){return _ref.apply(this,arguments);};}();Hugo.action('projects',function(){var homedir=process.env.HOME||'';var projectsFile=Hugo.cacheFile(path.resolve(homedir,'.atom','projects.cson'),'projects');var configFile=Hugo.cacheFile(path.resolve(homedir,'.atom','config.cson'),'config');checkEnvironmentChanges();projectsFile.on('change',function(cache,file){var projects=CSON.parse(file)||[];projects=Project.parseAll(projects);Icons.rebuild(projects,{onlyMissing:true});projects.sort(function(a,b){var nameA=a.title.toLowerCase();var nameB=b.title.toLowerCase();if(nameA<nameB){return-1;}if(nameA>nameB){return 1;}return 0;});cache.store(projects);});configFile.on('change',function(cache,file){var config=CSON.parse(file)||{};config=config['*']||{};cache.store(config);});var projects=projectsFile.get()||[];var config=configFile.get();if(config['project-manager']&&config['project-manager'].includeGitRepositories===true){var projectHome=config.core.projectHome||path.resolve(homedir,'github');var prettifyTitle=config['project-manager'].prettifyTitle===undefined?true:config['project-manager'].prettifyTitle;var gitProjects=Project.findGitRepositories(projectHome,prettifyTitle)||[];if(projects.length>0){gitProjects=gitProjects.filter(function(gitProject){var existingPaths=[];projects.forEach(function(project){var paths=project.subtitle.split(', ')||[];existingPaths=existingPaths.concat(paths);});return!existingPaths.includes(gitProject.subtitle);});}projects=projects.concat(gitProjects);}if(projects&&Array.isArray(projects)){if(!Icons.checkDependencies()&&Icons.usedIcons(projects).length>0){console.error(`Missing dependencies to render project icons. Please run: cd ${__dirname} && npm install`);Hugo.addItem({title:'Missing dependencies',subtitle:'Missing dependencies to render project icons. Please press enter to install.',arg:__dirname,variables:{task:'wfDependencies'},valid:true,mods:{alt:{valid:true,subtitle:'View documentation on this issue.',arg:'https://github.com/Cloudstek/alfred-hugo/blob/master/README.md'}}});}Hugo.addItems(projects);checkIcons(projects);}if(Hugo.itemCount===0){Hugo.addItem({title:'No projects found.'});}Hugo.feedback();});
//# sourceMappingURL=main.js.map
