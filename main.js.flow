// @flow

const Hugo = require('alfred-hugo');
const CSON = require('cson-parser');
const path = require('path');
const fs = require('fs');

const Project = require('./project');
const Icons = require('./icons');

const checkIcons = async (projects: Array<Object>) => {
    const themePath: string = Hugo.alfredMeta.themeFile;
    const lastTheme: ?string = Hugo.cache.get('lastTheme');

    try {
        fs.statSync(path.join(__dirname, 'icons'));
    } catch (e) {
        Hugo.cache.set('lastTheme', Hugo.alfredMeta.theme);
        Icons.rebuild(projects);
        return;
    }

    if (!lastTheme || lastTheme !== Hugo.alfredMeta.theme) {
        Hugo.cache.set('lastTheme', Hugo.alfredMeta.theme);
        Icons.rebuild(projects);
        return;
    }

    if (themePath) {
        const themeFile = Hugo.cacheFile(themePath, 'theme');

        themeFile.on('change', () => {
            Icons.rebuild(projects);
        });

        themeFile.get();
    }
};

Hugo.action('projects', query => {
    if (!query || query.length === 0) {
        Hugo.feedback();
    }

    // Home dir
    const homedir = process.env.HOME || '';

    // Projects file
    const projectsFile = Hugo.cacheFile(path.resolve(homedir, '.atom', 'projects.cson'), 'projects');

    // Parse projects
    projectsFile.on('change', (cache, file) => {
        // Read projects file
        let projects = CSON.parse(file) || [];

        // Parse projects
        projects = Project.parseAll(projects);

        // Rebuild icons when needed
        Icons.rebuild(projects, {onlyMissing: true});

        // Sort projects
        projects.sort((a, b) => {
            let nameA = a.title.toLowerCase();
            let nameB = b.title.toLowerCase();

            if (nameA < nameB) {
                return -1;
            }

            if (nameA > nameB) {
                return 1;
            }

            return 0;
        });

        cache.store(projects);
    });

    // Add projects to Hugo
    let projects = projectsFile.get();

    if (projects && Array.isArray(projects)) {
        Hugo.addItems(projects);

        // Check icons
        checkIcons(projects);
    }

    // Filter items by query
    Hugo.filterItems(query.trim());

    // Check if any projects found
    if (Hugo.itemCount < 1) {
        Hugo.addItem({
            title: 'No projects found.'
        });
    }

    // Output
    Hugo.feedback();
});
